---
phase: 05-multi-trace-and-export
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/components/traces/MultiTraceView.tsx
  - src/components/controls/CellSelector.tsx
  - src/components/controls/ExportPanel.tsx
  - src/App.tsx
  - src/styles/multi-trace.css
autonomous: false

must_haves:
  truths:
    - "User can view multiple traces simultaneously as compact mini-panels below the primary trace"
    - "User can switch between top-active, random, and manual cell selection modes"
    - "User can click a mini-panel to switch that cell to the primary view"
    - "User can pin current parameters and see before/after comparison overlay"
    - "User can click Export and download a JSON file with full parameter metadata"
    - "Multi-cell batch solve triggers on parameter commit, not on slider drag"
  artifacts:
    - path: "src/components/traces/MultiTraceView.tsx"
      provides: "Compact mini-panel grid rendering raw+fit overlay for each selected cell"
      min_lines: 40
    - path: "src/components/controls/CellSelector.tsx"
      provides: "Cell selection mode dropdown, display count input, manual cell toggles"
      min_lines: 30
    - path: "src/components/controls/ExportPanel.tsx"
      provides: "Export button triggering JSON download with current parameters"
      min_lines: 20
    - path: "src/App.tsx"
      provides: "Integration of MultiTraceView, CellSelector, ExportPanel, pin/unpin button, batch solve wiring"
      contains: "MultiTraceView|CellSelector|ExportPanel|solveSelectedCells"
    - path: "src/styles/multi-trace.css"
      provides: "Dark theme styling for multi-trace mini-panels, cell selector, export panel"
  key_links:
    - from: "src/App.tsx"
      to: "src/lib/multi-cell-solver.ts"
      via: "calls solveSelectedCells on parameter commit (onCommit callback)"
      pattern: "solveSelectedCells"
    - from: "src/App.tsx"
      to: "src/lib/viz-store.ts"
      via: "calls pinCurrentSnapshot/unpinSnapshot via pin button"
      pattern: "pinCurrentSnapshot|unpinSnapshot"
    - from: "src/App.tsx"
      to: "src/lib/export.ts"
      via: "calls buildExportData + downloadExport on export button click"
      pattern: "buildExportData|downloadExport"
    - from: "src/components/traces/MultiTraceView.tsx"
      to: "src/lib/multi-cell-store.ts"
      via: "reads multiCellResults signal for rendering mini-panels"
      pattern: "multiCellResults"
    - from: "src/components/controls/CellSelector.tsx"
      to: "src/lib/multi-cell-store.ts"
      via: "reads/sets selectionMode, displayCount, selectedCells"
      pattern: "selectionMode|setSelectionMode|displayCount|setDisplayCount"
---

<objective>
Build the UI components for multi-trace viewing, cell selection, and parameter export, then wire everything into the App.

Purpose: This is the user-facing integration plan that makes the Phase 5 data layer (Plan 01) and export/snapshot features (Plan 02) accessible through the UI. After this plan, users can validate parameters across multiple cells, compare before/after snapshots, and export their chosen parameters.

Output: MultiTraceView, CellSelector, and ExportPanel components, multi-trace CSS, and complete App.tsx integration with batch solve wiring.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-trace-and-export/05-RESEARCH.md
@.planning/phases/05-multi-trace-and-export/05-01-SUMMARY.md
@.planning/phases/05-multi-trace-and-export/05-02-SUMMARY.md
@src/App.tsx
@src/lib/viz-store.ts
@src/lib/data-store.ts
@src/lib/multi-cell-store.ts
@src/lib/multi-cell-solver.ts
@src/lib/export.ts
@src/components/traces/TracePanelStack.tsx
@src/components/traces/TracePanel.tsx
@src/components/controls/ParameterPanel.tsx
@src/styles/controls.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: MultiTraceView, CellSelector, and ExportPanel components with styling</name>
  <files>src/components/traces/MultiTraceView.tsx, src/components/controls/CellSelector.tsx, src/components/controls/ExportPanel.tsx, src/styles/multi-trace.css</files>
  <action>
**src/components/traces/MultiTraceView.tsx:**

Compact mini-panel grid for displaying multi-cell results:

Props:
- `onCellClick: (cellIndex: number) => void` -- called when user clicks a mini-panel to switch primary cell

Implementation:
- Import `multiCellResults, multiCellSolving, multiCellProgress` from multi-cell-store
- Import `For, Show` from solid-js
- Import `TracePanel` from './TracePanel'
- Import `downsampleMinMax` from '../../lib/chart/downsample'
- Import `samplingRate` from '../../lib/data-store'

Render a `<Show when={multiCellResults().size > 0}>` wrapper:
- Inside, show a section with heading "Multi-Cell Comparison" and subtitle showing count
- Use `<For each={[...multiCellResults().entries()]}>` to iterate cells
- Each mini-panel:
  - A clickable div with class "mini-panel" and onClick calling props.onCellClick(cellIndex)
  - Label: "Cell {cellIndex + 1}" (1-indexed for display)
  - TracePanel with:
    - data: createMemo computing [dsX, dsRaw, dsFit] via downsampleMinMax with bucket width 600 (smaller than main panels since these are compact)
    - series: [{}, { label: 'Raw', stroke: 'hsl(200, 60%, 50%)', width: 1 }, { label: 'Fit', stroke: 'hsl(30, 90%, 60%)', width: 1 }]
    - height: 80 (compact)
    - syncKey: 'catune-multi' (separate sync group from main panels)
  - Time axis generation: same makeTimeAxis pattern as TracePanelStack (dt = 1/fs, x[i] = i*dt)

Show solving progress indicator when multiCellSolving() is true:
- "Solving cell {current} of {total}..." with a subtle pulsing animation

**src/components/controls/CellSelector.tsx:**

Cell selection mode controls:

Props:
- `onSelectionChange: () => void` -- called when selection changes (triggers batch re-solve)

Implementation:
- Import selection signals from multi-cell-store: selectionMode, setSelectionMode, displayCount, setDisplayCount, selectedCells, setSelectedCells, updateCellSelection
- Import numCells from data-store

Render:
- Mode selector: three radio buttons or a `<select>` dropdown for 'top-active' | 'random' | 'manual'
  - Label: "Selection Mode"
  - On change: set selectionMode, call updateCellSelection(), then call props.onSelectionChange()
- Display count: a number input (min 1, max min(20, numCells()), default 5)
  - Label: "Number of cells"
  - On change: set displayCount, call updateCellSelection(), then call props.onSelectionChange()
  - Only shown when mode is NOT 'manual'
- Manual mode: when selectionMode() === 'manual', show a simple cell index input or cell list
  - A comma-separated text input where user types cell indices (1-indexed for UX, convert to 0-indexed internally)
  - Parse on blur/enter: split by comma, parseInt each, subtract 1, filter valid indices, set selectedCells
  - On change: call props.onSelectionChange()
- "Reshuffle" button: only visible when mode is 'random', calls updateCellSelection() then onSelectionChange() to get a new random sample

**src/components/controls/ExportPanel.tsx:**

Parameter export controls:

Props:
- None needed (reads directly from viz-store and data-store)

Implementation:
- Import tauRise, tauDecay, lambda from viz-store
- Import samplingRate, parsedData, effectiveShape, rawFile from data-store
- Import buildExportData, downloadExport from '../../lib/export'

Render:
- An "Export Parameters" button (class "btn-primary")
- On click:
  - Call buildExportData with current parameter values from viz-store signals
  - Pass metadata: sourceFilename from rawFile()?.name, numCells and numTimepoints from effectiveShape()
  - Call downloadExport with the result
- Show a brief summary of what will be exported: "tau_rise: {ms}ms, tau_decay: {ms}ms, lambda: {val}"

**src/styles/multi-trace.css:**

Dark theme styles matching the existing project CSS custom properties (--bg-primary, --bg-secondary, --text-primary, etc. from styles.css):

- `.multi-trace-section`: margin-top, padding
- `.multi-trace-header`: flex layout with title and count
- `.mini-panel`: border 1px solid var(--border-color), border-radius 6px, padding 4px, cursor pointer, hover effect (border brightens), transition
- `.mini-panel__label`: small font, var(--text-secondary), margin-bottom 2px
- `.mini-panel__active`: highlighted border for the currently primary cell
- `.multi-trace-grid`: CSS grid, `grid-template-columns: repeat(auto-fill, minmax(300px, 1fr))`, gap 8px
- `.cell-selector`: flex layout with gap, align-items center
- `.cell-selector__mode`: select/radio styling
- `.cell-selector__count`: number input styling (width 60px)
- `.export-panel`: flex layout, align-items center, gap, border-top for visual separation
- `.export-panel__summary`: small text, var(--text-secondary)
- `.solving-progress`: text-center, pulsing animation (reuse the convergence-indicator pulse pattern from controls.css)
  </action>
  <verify>
`npx tsc --noEmit` passes. `npx vitest run` passes. Verify component files exist and export expected components: `grep -n 'export function' src/components/traces/MultiTraceView.tsx src/components/controls/CellSelector.tsx src/components/controls/ExportPanel.tsx`.
  </verify>
  <done>
MultiTraceView renders compact mini-panels for each selected cell with raw+fit overlay. CellSelector provides mode switching (top-active/random/manual) with display count control. ExportPanel triggers JSON download with current parameters. All styled with dark theme CSS.
  </done>
</task>

<task type="auto">
  <name>Task 2: App.tsx integration -- wire multi-trace, export, and snapshot features</name>
  <files>src/App.tsx</files>
  <action>
Integrate all Phase 5 components into App.tsx. Modify the existing 'ready' state rendering.

New imports:
- MultiTraceView from './components/traces/MultiTraceView'
- CellSelector from './components/controls/CellSelector'
- ExportPanel from './components/controls/ExportPanel'
- computeAndCacheRanking, updateCellSelection, selectedCells, multiCellResults from './lib/multi-cell-store'
- solveSelectedCells from './lib/multi-cell-solver'
- pinCurrentSnapshot, unpinSnapshot, pinnedParams from './lib/viz-store'
- parsedData, effectiveShape, swapped, samplingRate from './lib/data-store' (some already imported)
- tauRise, tauDecay, lambda from './lib/viz-store' (some already imported)
- '../styles/multi-trace.css'

Modifications to the 'ready' createEffect:
- After loadCellTraces(0, ...) and startTuningLoop(), add:
  - computeAndCacheRanking() -- compute cell activity ranking once
  - updateCellSelection() -- populate selectedCells based on default mode (top-active, 5 cells)
  - Then trigger initial batch solve: `solveSelectedCells(selectedCells(), { tauRise: tauRise(), tauDecay: tauDecay(), lambda: lambda(), fs: samplingRate() ?? 30 }, parsedData()!, effectiveShape()!, swapped())`

Modify the onCommit callback passed to ParameterPanel:
- After calling commitToHistory(snapshot), also trigger batch re-solve for selected cells:
  - `solveSelectedCells(selectedCells(), { tauRise: snapshot.tauRise, tauDecay: snapshot.tauDecay, lambda: snapshot.lambda, fs: samplingRate() ?? 30 }, parsedData()!, effectiveShape()!, swapped())`
  - CRITICAL: This triggers on onCommit (onChange), NOT on every slider drag. The existing onInput -> tuning-orchestrator handles live primary cell updates.

Add to the viz-container section (below ParameterPanel, above TracePanelStack):
- A toolbar row with:
  - Pin/Unpin button: `<button onClick={pinnedParams() ? unpinSnapshot : pinCurrentSnapshot}>{pinnedParams() ? 'Unpin Snapshot' : 'Pin for Comparison'}</button>`
  - Show pinned params summary when pinned: "Pinned: rise={ms}ms, decay={ms}ms, lambda={val}"
  - ExportPanel component

Update the viz-header subtitle to show the current primary cell number:
- Change "Cell 1 of N" to use selectedCell() + 1 (already 0-indexed in viz-store)
- Import selectedCell from viz-store if not already imported

Add below TracePanelStack (still inside viz-container):
- CellSelector with onSelectionChange callback that triggers batch re-solve
- MultiTraceView with onCellClick handler that:
  1. Calls loadCellTraces(clickedCellIndex, data, shape, isSwapped) to switch primary cell
  2. The tuning orchestrator's reactive effect will automatically re-solve the new primary cell

Handle cell click in MultiTraceView -> switch primary cell:
- loadCellTraces already clears pinned snapshot (from Plan 02's modification)
- The batch results remain in multiCellResults -- they don't need re-solving because they show how the current parameters perform on each cell

KernelDisplay stays at the bottom (after MultiTraceView).
  </action>
  <verify>
`npx tsc --noEmit` passes. `npx vitest run` passes. `npx vite build` succeeds. Verify integration: `grep -c 'MultiTraceView\|CellSelector\|ExportPanel\|solveSelectedCells\|pinCurrentSnapshot' src/App.tsx` should show all features wired.
  </verify>
  <done>
App.tsx integrates all Phase 5 features: multi-trace mini-panels below main view, cell selector with mode switching, export button triggering JSON download, pin/unpin button for before/after comparison. Batch solve triggers on parameter commit only. Cell click in mini-panels switches primary cell. All features accessible from the main tuning view.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify multi-trace, snapshot, and export features</name>
  <files>src/App.tsx</files>
  <action>
Human verification of complete Phase 5 features. All implementation is done in Tasks 1-2. This checkpoint confirms the integrated experience works correctly from the user's perspective.
  </action>
  <verify>
1. Run `npm run dev` and load data (or click "Load Demo Data")
2. After data loads, verify:
   a. The primary trace view (Raw+Fit, Deconvolved, Residuals) renders as before
   b. Below the main panels, a "Multi-Cell Comparison" section shows 5 mini-panels with raw+fit overlays
   c. Each mini-panel is labeled "Cell N" and shows a compact chart

3. Test cell selection:
   a. Find the cell selector controls
   b. Switch mode to "Random" -- mini-panels should show different cells
   c. Click "Reshuffle" -- should show a new random set
   d. Change display count to 3 -- should show 3 mini-panels
   e. Switch to "Manual" mode -- enter cell indices (e.g., "1, 5, 10") -- those cells should appear

4. Test mini-panel click:
   a. Click on any mini-panel
   b. The main trace view should switch to show that cell
   c. The header subtitle should update to show the new cell number

5. Test before/after comparison:
   a. Adjust a parameter slider (e.g., change decay time)
   b. Click "Pin for Comparison"
   c. A dimmed dashed overlay should appear on the Raw+Fit and Deconvolved panels showing the pinned results
   d. Adjust the slider again -- the current (bright) fit should change while the pinned (dimmed dashed) fit stays fixed
   e. Click "Unpin Snapshot" -- the overlay should disappear
   f. Pin again, then click a different cell in the mini-panels -- the pinned overlay should auto-clear

6. Test parameter export:
   a. Click "Export Parameters"
   b. A JSON file should download (named catune-params-YYYY-MM-DD.json)
   c. Open the file and verify it contains: schema_version, catune_version, parameters (tau values, lambda, sampling rate), ar2_coefficients (g1, g2, d, r), formulation (model, objective, kernel strings), metadata

7. Test batch solve on parameter change:
   a. With multi-cell view visible, drag a slider -- mini-panels should NOT update during drag
   b. Release the slider (commit) -- mini-panels should update after a brief solve (progress indicator visible)
  </verify>
  <done>
All Phase 5 features verified by user: multi-trace view, cell selection modes, mini-panel click-to-switch, before/after pinned overlay, parameter export JSON, and batch solve on commit only.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full type check passes
2. `npx vitest run` -- all tests pass
3. `npx vite build` -- production build succeeds
4. Multi-cell mini-panels render for selected cells
5. Cell selection modes (top-active, random, manual) work correctly
6. Before/after pinned overlay renders as dimmed dashed lines
7. Export produces valid JSON with complete metadata
8. Batch solve triggers on commit only, not on drag
</verification>

<success_criteria>
- User can view 3-10 cells simultaneously in compact mini-panels
- User can switch selection mode and see different cells
- User can click a mini-panel to switch primary cell
- Pin/unpin creates a visible before/after overlay with dimmed dashed lines
- Export downloads a complete JSON file with AR2 coefficients and formulation
- Mini-cell results update on parameter commit, not on slider drag
- All Phase 5 success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-trace-and-export/05-03-SUMMARY.md`
</output>

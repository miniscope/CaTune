---
phase: 06-tutorial-system
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/controls/ParameterSlider.tsx
  - src/components/controls/ParameterPanel.tsx
  - src/components/controls/ConvergenceIndicator.tsx
  - src/components/controls/CellSelector.tsx
  - src/components/controls/ExportPanel.tsx
  - src/components/traces/TracePanelStack.tsx
  - src/components/traces/KernelDisplay.tsx
  - src/components/traces/MultiTraceView.tsx
  - src/App.tsx
  - src/lib/tutorial/content/01-basics.ts
  - src/lib/tutorial/content/02-workflow.ts
  - src/lib/tutorial/content/03-advanced.ts
  - src/lib/tutorial/content/index.ts
autonomous: true

must_haves:
  truths:
    - "All ~15 UI elements have stable data-tutorial attributes that driver.js can target"
    - "Three tutorial content modules define progressive learning: basics, workflow, advanced"
    - "Tutorial content is pure data (no driver.js imports) satisfying TUTR-05"
  artifacts:
    - path: "src/lib/tutorial/content/01-basics.ts"
      provides: "TUTR-01: Understanding Parameters tutorial (~12 steps)"
      exports: ["basicsTutorial"]
    - path: "src/lib/tutorial/content/02-workflow.ts"
      provides: "TUTR-02: Guided Tuning Workflow tutorial (~15 steps)"
      exports: ["workflowTutorial"]
    - path: "src/lib/tutorial/content/03-advanced.ts"
      provides: "TUTR-03: Advanced Techniques tutorial (~10 steps)"
      exports: ["advancedTutorial"]
    - path: "src/lib/tutorial/content/index.ts"
      provides: "Tutorial registry mapping IDs to Tutorial objects"
      exports: ["tutorials", "getTutorialById"]
    - path: "src/components/controls/ParameterPanel.tsx"
      provides: "data-tutorial attributes on param-panel, slider-rise, slider-decay, slider-lambda"
      contains: "data-tutorial"
    - path: "src/components/traces/TracePanelStack.tsx"
      provides: "data-tutorial attributes on trace-raw-fit, trace-deconvolved, trace-residuals"
      contains: "data-tutorial"
  key_links:
    - from: "src/lib/tutorial/content/01-basics.ts"
      to: "src/lib/tutorial/types.ts"
      via: "import type { Tutorial } from '../types'"
      pattern: "import.*Tutorial.*from.*types"
    - from: "src/lib/tutorial/content/index.ts"
      to: "src/lib/tutorial/content/01-basics.ts"
      via: "re-exports all tutorials"
      pattern: "import.*basicsTutorial"
    - from: "tutorial content steps"
      to: "existing components"
      via: "data-tutorial selectors matching attributes added to components"
      pattern: "data-tutorial="
---

<objective>
Add stable data-tutorial selector attributes to all existing UI components and create the three progressive tutorial content definitions (basics, workflow, advanced) as data-driven TypeScript modules.

Purpose: Provides the targeting contract between tutorial steps and UI elements (TUTR-04), and implements all tutorial content as pure data separated from engine code (TUTR-05). Covers TUTR-01, TUTR-02, TUTR-03 requirements.
Output: 15 data-tutorial attributes on existing components + 3 tutorial content modules + registry.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-tutorial-system/06-RESEARCH.md
@.planning/phases/06-tutorial-system/06-01-SUMMARY.md
@src/App.tsx
@src/components/controls/ParameterSlider.tsx
@src/components/controls/ParameterPanel.tsx
@src/components/controls/ConvergenceIndicator.tsx
@src/components/controls/CellSelector.tsx
@src/components/controls/ExportPanel.tsx
@src/components/traces/TracePanelStack.tsx
@src/components/traces/KernelDisplay.tsx
@src/components/traces/MultiTraceView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data-tutorial attributes to existing UI components</name>
  <files>
    src/components/controls/ParameterSlider.tsx
    src/components/controls/ParameterPanel.tsx
    src/components/controls/ConvergenceIndicator.tsx
    src/components/controls/CellSelector.tsx
    src/components/controls/ExportPanel.tsx
    src/components/traces/TracePanelStack.tsx
    src/components/traces/KernelDisplay.tsx
    src/components/traces/MultiTraceView.tsx
    src/App.tsx
  </files>
  <action>
Add `data-tutorial` attributes to ~15 elements across 9 files. Each change is a single attribute addition to an existing JSX element. No behavioral changes.

**ParameterSlider.tsx:**
- Add optional `'data-tutorial'?: string` to ParameterSliderProps interface
- Spread it onto the root `<div class="param-slider">`: `data-tutorial={props['data-tutorial']}`

**ParameterPanel.tsx:**
- Add `data-tutorial="param-panel"` to root `<div class="param-panel">`
- Pass `data-tutorial="slider-rise"` to the Rise Time ParameterSlider
- Pass `data-tutorial="slider-decay"` to the Decay Time ParameterSlider
- Pass `data-tutorial="slider-lambda"` to the Sparsity ParameterSlider

**ConvergenceIndicator.tsx:**
- Add `data-tutorial="convergence-indicator"` to root `<div class="convergence ...">` element

**CellSelector.tsx:**
- Add `data-tutorial="cell-selector"` to root `<div class="cell-selector">`

**ExportPanel.tsx:**
- Add `data-tutorial="export-panel"` to root `<div class="export-panel">`

**TracePanelStack.tsx:**
- Add `data-tutorial="trace-raw-fit"` to the first `<div class="trace-stack__panel">` (Raw + Fit panel)
- Add `data-tutorial="trace-deconvolved"` to the second `<div class="trace-stack__panel">` (Deconvolved Activity panel)
- Add `data-tutorial="trace-residuals"` to the third `<div class="trace-stack__panel">` (Residuals panel)

**KernelDisplay.tsx:**
- Add `data-tutorial="kernel-display"` to root `<div class="kernel-section">`

**MultiTraceView.tsx:**
- Add `data-tutorial="multi-trace-view"` to `<section class="multi-trace-section">`

**App.tsx:**
- Add `data-tutorial="app-header"` to `<header class="app-header">`
- Add `data-tutorial="viz-container"` to `<section class="viz-container">`
- Add `data-tutorial="pin-snapshot"` to the Pin for Comparison button

Important: Do NOT change any component behavior, props (except ParameterSlider adding data-tutorial prop), logic, or styling. Only add data-tutorial attributes.
  </action>
  <verify>
`npx tsc --noEmit` passes. Grep for `data-tutorial=` across all modified files confirms 15 attributes added. `npm run build` succeeds.
  </verify>
  <done>
15 data-tutorial attributes placed on: param-panel, slider-rise, slider-decay, slider-lambda, convergence-indicator, cell-selector, export-panel, trace-raw-fit, trace-deconvolved, trace-residuals, kernel-display, multi-trace-view, app-header, viz-container, pin-snapshot. All existing component behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create three progressive tutorial content definitions and registry</name>
  <files>
    src/lib/tutorial/content/01-basics.ts
    src/lib/tutorial/content/02-workflow.ts
    src/lib/tutorial/content/03-advanced.ts
    src/lib/tutorial/content/index.ts
  </files>
  <action>
Create tutorial content as TypeScript modules that import ONLY the Tutorial type from '../types'. No driver.js imports in content files (TUTR-05 compliance).

**src/lib/tutorial/content/01-basics.ts** -- TUTR-01: Understanding Parameters
Export `basicsTutorial: Tutorial` with id='basics', level='beginner', prerequisites=[], estimatedMinutes=3, ~12 steps:
1. Welcome (no element -- centered modal): "Welcome to CaTune. This tutorial teaches you the basics of calcium trace deconvolution -- what each parameter controls and how to recognize a good fit."
2. element='[data-tutorial="trace-raw-fit"]', title="Your Raw Trace and Model Fit", description: "This panel shows your raw fluorescence data (blue line) and the model's reconvolution fit (orange line). When the orange closely follows the blue peaks, your parameters are producing a good fit.", side='bottom'
3. element='[data-tutorial="trace-deconvolved"]', title="Deconvolved Activity", description: "This panel shows the inferred neural spiking activity -- the output of deconvolution. Each peak represents a detected calcium event. Clean, sharp peaks indicate well-tuned parameters.", side='bottom'
4. element='[data-tutorial="trace-residuals"]', title="Residuals: Your Diagnostic Tool", description: "The residual is the difference between raw data and the model fit. Good residuals look like random noise. If you see structured patterns (repeated bumps, systematic drift), the model is missing real signal.", side='bottom'
5. element='[data-tutorial="slider-decay"]', title="Decay Time (tau_decay)", description: "Controls how quickly calcium decays after a neural event. This is the most important parameter -- start here. Typical values: 200-800ms for GCaMP6f, 400-1500ms for GCaMP7f. Too short: fit undershoots after peaks. Too long: fit is sluggish and bleeds into the next event.", side='right'
6. element='[data-tutorial="slider-rise"]', title="Rise Time (tau_rise)", description: "Controls how quickly calcium rises at the onset of an event. Usually much shorter than decay (5-50ms). Fine-tune this after decay is set. Too short: sharp onset artifacts. Too long: fit lags behind the true rise.", side='right'
7. element='[data-tutorial="slider-lambda"]', title="Sparsity Penalty (lambda)", description: "Controls how many events the model detects. Higher lambda = fewer, cleaner events. Lower lambda = more events but also more noise. Start low and increase until noise spikes disappear from the deconvolved trace without losing real events.", side='right'
8. element='[data-tutorial="kernel-display"]', title="Calcium Kernel Shape", description: "This shows the shape of a single calcium event as defined by your current rise and decay times. It is the 'template' the model uses to find events in your data. The shape should match what a real calcium transient looks like for your indicator.", side='right'
9. element='[data-tutorial="convergence-indicator"]', title="Solver Status", description: "Shows whether the deconvolution solver is still computing (Solving...) or has finished (Converged). When you adjust parameters, the solver re-runs. Wait for 'Converged' before judging the fit quality.", side='bottom'
10. element='[data-tutorial="param-panel"]', title="Good Fit vs Bad Fit", description: "A good fit: orange closely tracks blue peaks, residuals look like noise, deconvolved trace has clean events. A bad fit: orange misses peaks or is too smooth, residuals show structure, deconvolved trace is noisy or has missing events. Try different parameter values to see the difference.", side='left'
11. element='[data-tutorial="pin-snapshot"]', title="Compare Parameters", description: "Use 'Pin for Comparison' to save the current fit as a faded overlay. Then adjust parameters and see the new fit alongside the old one -- a quick way to judge if your changes improved things.", side='bottom'
12. Completion (no element): "You now understand the basic parameters and what to look for. Next, try the 'Guided Tuning Workflow' tutorial to learn the recommended step-by-step tuning process."

**src/lib/tutorial/content/02-workflow.ts** -- TUTR-02: Guided Tuning Workflow
Export `workflowTutorial: Tutorial` with id='workflow', level='intermediate', prerequisites=['basics'], estimatedMinutes=5, ~15 steps:
1. No element: "This tutorial walks you through the recommended tuning workflow used by the Aharoni Lab. You will adjust parameters step by step on your own data."
2. element='[data-tutorial="cell-selector"]', title="Step 1: Pick a Good Starting Cell", description: "Start with a cell that has clear, isolated events visible in the raw trace. Use 'Top Active' mode to find cells with strong activity. Click a mini-panel below to switch cells.", side='top'
3. element='[data-tutorial="trace-raw-fit"]', title="Look for Clean Events", description: "Scan the raw trace for sharp, well-separated peaks. Avoid cells dominated by noise or slow baseline drift. A cell with a few clear events is ideal for initial tuning.", side='bottom'
4. element='[data-tutorial="slider-decay"]', title="Step 2: Tune Decay Time", description: "Decay has the biggest visual impact. Drag the slider and watch the orange fit line. Adjust until the fit's falling edge matches the raw trace's falling edge after each peak. Try it now.", side='right', waitForAction='slider-change', disableActiveInteraction=false
5. element='[data-tutorial="trace-raw-fit"]', title="Check the Fit", description: "Look at how the orange fit line follows the blue raw trace after peaks. The tails should line up. If the fit drops too fast, increase decay. If it lingers too long, decrease decay.", side='bottom'
6. element='[data-tutorial="trace-residuals"]', title="Step 3: Check Residuals", description: "Good residuals are flat noise. If you see bumps after peaks (positive residuals), decay is too short -- the model drops off before the real signal does. If you see dips (negative residuals), decay may be too long.", side='bottom'
7. element='[data-tutorial="slider-rise"]', title="Step 4: Fine-Tune Rise Time", description: "Now adjust the rise time. This is subtle -- it affects the onset of each event. Watch the leading edge of peaks in the fit. Drag to adjust.", side='right', waitForAction='slider-change', disableActiveInteraction=false
8. element='[data-tutorial="trace-raw-fit"]', title="Check Rise Slopes", description: "Zoom into a peak onset. The orange fit should match the blue trace's upward slope. If the fit rises too slowly, decrease rise time. If it overshoots, increase it slightly. Note: changing rise time may slightly affect the optimal decay -- re-check.", side='bottom'
9. element='[data-tutorial="slider-lambda"]', title="Step 5: Add Sparsity", description: "Increase lambda to clean up the deconvolved trace. Start low and increase until noise spikes disappear. Stop before real events start vanishing. Drag to adjust.", side='right', waitForAction='slider-change', disableActiveInteraction=false
10. element='[data-tutorial="trace-deconvolved"]', title="Check Deconvolved Quality", description: "The deconvolved trace should show clean, sharp peaks at real events with a quiet baseline between them. If the baseline is still noisy, increase lambda. If events are disappearing, decrease it.", side='bottom'
11. element='[data-tutorial="multi-trace-view"]', title="Step 6: Validate Across Cells", description: "Good parameters should work across diverse cells, not just one. The mini-panels below show how your current parameters perform on multiple cells. Look for consistent fit quality.", side='top'
12. element='[data-tutorial="cell-selector"]', title="Check Different Cell Types", description: "Switch between 'Top Active', 'Random', and 'Manual' selection to test parameters on cells with different activity levels. Parameters that only work on high-SNR cells may need adjustment.", side='top'
13. element='[data-tutorial="pin-snapshot"]', title="Step 7: Compare Iterations", description: "Pin your current parameters, then make adjustments. The dashed overlay lets you see whether your changes improved the fit. This is especially useful for subtle lambda adjustments.", side='bottom'
14. element='[data-tutorial="export-panel"]', title="Step 8: Export When Satisfied", description: "Once your parameters produce good fits across diverse cells, export them. The JSON file includes all parameter values, AR2 coefficients for downstream analysis, and metadata about your dataset.", side='top'
15. No element: "Excellent! You have completed the guided tuning workflow. Your exported parameters can be used directly in analysis pipelines. For deeper insights, try the 'Advanced Techniques' tutorial."

**src/lib/tutorial/content/03-advanced.ts** -- TUTR-03: Advanced Techniques
Export `advancedTutorial: Tutorial` with id='advanced', level='advanced', prerequisites=['workflow'], estimatedMinutes=3, ~10 steps:
1. No element: "This tutorial covers advanced deconvolution concepts: residual analysis, parameter coupling, indicator-specific guidance, and common artifacts."
2. element='[data-tutorial="trace-residuals"]', title="Residual Pattern Analysis", description: "Structured residuals reveal specific model mismatches. Systematic positive bumps after peaks: decay too short. Negative dips before peaks: rise too long. Low-frequency waves: baseline drift (not a parameter issue -- may need preprocessing). Periodic patterns: possible motion artifact.", side='bottom'
3. element='[data-tutorial="param-panel"]', title="Parameter Coupling", description: "Rise and decay times interact. Changing decay often shifts the optimal rise time. After adjusting decay, always re-check rise. Lambda interacts too: with longer decay, the model explains more variance, so you may need less sparsity. Always tune in order: decay first, then rise, then lambda.", side='left'
4. element='[data-tutorial="kernel-display"]', title="Indicator-Specific Guidance", description: "Different calcium indicators have different kinetics. <b>GCaMP6f:</b> fast, decay ~200-400ms. <b>GCaMP6s:</b> slow, decay ~500-1500ms. <b>GCaMP7f:</b> medium-fast, decay ~300-600ms. <b>jGCaMP8f:</b> ultra-fast, decay ~50-200ms. Use these ranges as starting points, then refine on your data.", side='right'
5. element='[data-tutorial="trace-raw-fit"]', title="Recognizing Artifacts", description: "Common artifacts that affect fitting: <b>Motion artifacts:</b> sharp, symmetric deflections (not calcium-shaped). <b>Photobleaching:</b> slow downward baseline trend. <b>Neuropil contamination:</b> broad, slow signals mixed with sharp events. These cannot be fixed by parameter tuning -- they require preprocessing.", side='bottom'
6. element='[data-tutorial="trace-deconvolved"]', title="Fast Firing and Overlapping Events", description: "When neurons fire rapidly, calcium events overlap. The model handles this via superposition, but dense firing can make individual events hard to resolve. If you see merged events, try slightly shorter decay time. Very fast firing may require higher sampling rates to resolve.", side='bottom'
7. element='[data-tutorial="multi-trace-view"]', title="Multi-Cell Consistency", description: "Some variation in fit quality across cells is normal -- cells differ in baseline noise, activity rate, and expression level. Aim for parameters that work well for the majority. If a few cells look terrible, they may have issues unrelated to parameter choice (dead cells, out-of-focus, artifacts).", side='top'
8. element='[data-tutorial="slider-decay"]', title="When Sampling Rate Matters", description: "If your sampling rate is low (e.g., 10 Hz), fast dynamics are undersampled and parameters may need to be wider to compensate. If your data was recorded at a different rate than entered, all parameter values will be off. Double-check your sampling rate setting.", side='right'
9. element='[data-tutorial="export-panel"]', title="Publication-Quality Parameters", description: "For publications, report: rise time, decay time, lambda, sampling rate, and calcium indicator. Include the AR2 coefficients from the export JSON -- these are the mathematically equivalent autoregressive representation used by most analysis pipelines. Always note the CaTune version.", side='top'
10. No element: "You have covered advanced deconvolution techniques. Remember: the goal is parameters that produce clean deconvolved traces with residuals that look like noise across diverse cells. When in doubt, trust the residuals."

**src/lib/tutorial/content/index.ts** -- Tutorial Registry
- Import all three tutorials
- Export `tutorials: Tutorial[]` array in progression order
- Export `getTutorialById(id: string): Tutorial | undefined` lookup function

Important: Content files import ONLY `type { Tutorial }` from '../types'. Zero runtime dependencies. Content is pure typed data.
  </action>
  <verify>
`npx tsc --noEmit` passes. `npm run build` succeeds. Grep confirms data-tutorial attributes in all 9 component files. Grep confirms content files do NOT import from 'driver.js'. Content files import only from '../types'.
  </verify>
  <done>
15 data-tutorial attributes on existing UI components. Three tutorial modules: basics (~12 steps, beginner), workflow (~15 steps, intermediate with interactive waitForAction steps), advanced (~10 steps). Registry exports all tutorials. All content is pure typed data with no engine dependencies (TUTR-05).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. 15 data-tutorial attributes found across component files
4. 3 tutorial content files + 1 registry file exist in src/lib/tutorial/content/
5. Content files contain no driver.js imports (pure data, TUTR-05)
6. Each tutorial has correct level, prerequisites, and step count
7. All step element selectors match data-tutorial attribute values added to components
</verification>

<success_criteria>
- TUTR-01: basics tutorial covers what each parameter does and good vs bad fits (~12 steps)
- TUTR-02: workflow tutorial guides step-by-step tuning process with interactive steps (~15 steps)
- TUTR-03: advanced tutorial covers residual analysis, coupling, indicators, artifacts (~10 steps)
- TUTR-04: All tutorial steps reference actual UI elements via data-tutorial selectors
- TUTR-05: Tutorial content is pure data (no code changes needed to update text)
- All existing component behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-tutorial-system/06-02-SUMMARY.md`
</output>

---
phase: 06-tutorial-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tutorial/types.ts
  - src/lib/tutorial/progress.ts
  - src/lib/tutorial/tutorial-store.ts
  - src/lib/tutorial/tutorial-engine.ts
  - src/styles/tutorial.css
autonomous: true

must_haves:
  truths:
    - "Tutorial engine can start, advance, and stop a driver.js tour from typed step definitions"
    - "Tutorial progress persists to localStorage and survives page refresh"
    - "Driver.js popovers render with CaTune dark theme styling"
  artifacts:
    - path: "src/lib/tutorial/types.ts"
      provides: "TutorialStep, Tutorial type definitions"
      exports: ["TutorialStep", "Tutorial"]
    - path: "src/lib/tutorial/progress.ts"
      provides: "localStorage persistence for tutorial completion state"
      exports: ["saveProgress", "getProgress", "getAllProgress", "isCompleted", "clearProgress"]
    - path: "src/lib/tutorial/tutorial-store.ts"
      provides: "SolidJS signals for active tutorial state"
      exports: ["activeTutorial", "currentStepIndex", "isTutorialActive"]
    - path: "src/lib/tutorial/tutorial-engine.ts"
      provides: "Driver.js integration: start, stop, step mapping"
      exports: ["startTutorial", "stopTutorial"]
    - path: "src/styles/tutorial.css"
      provides: "Dark theme CSS overrides for driver.js popovers and overlay"
      contains: ".driver-popover"
  key_links:
    - from: "src/lib/tutorial/tutorial-engine.ts"
      to: "driver.js"
      via: "import { driver } from 'driver.js'"
      pattern: "import.*driver.*from.*driver.js"
    - from: "src/lib/tutorial/tutorial-engine.ts"
      to: "src/lib/tutorial/tutorial-store.ts"
      via: "setIsTutorialActive, setCurrentStepIndex calls"
      pattern: "setIsTutorialActive|setCurrentStepIndex"
    - from: "src/lib/tutorial/tutorial-engine.ts"
      to: "src/lib/tutorial/progress.ts"
      via: "saveProgress call on tutorial completion"
      pattern: "saveProgress"
---

<objective>
Install driver.js and build the tutorial engine foundation: type definitions, localStorage progress persistence, SolidJS reactive store, driver.js integration engine, and dark theme CSS overrides.

Purpose: Creates the infrastructure layer that all tutorial content and UI will depend on. Separates engine from content per TUTR-05 (data-driven).
Output: Working tutorial engine that can accept typed Tutorial objects and drive a themed driver.js tour.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-tutorial-system/06-RESEARCH.md
@src/styles/global.css
@src/lib/viz-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install driver.js and create tutorial type system and progress module</name>
  <files>
    src/lib/tutorial/types.ts
    src/lib/tutorial/progress.ts
  </files>
  <action>
Run `npm install driver.js` to add the dependency.

Create `src/lib/tutorial/types.ts` with these interfaces:
- `TutorialStep`: element (optional CSS selector string), title (string), description (string -- supports HTML), side ('top'|'bottom'|'left'|'right' optional), waitForAction (optional string identifier like 'slider-change'), setupParams (optional object with tauRise/tauDecay/lambda number fields), disableActiveInteraction (optional boolean, default undefined meaning driver.js default)
- `Tutorial`: id (string), title (string), description (string), level ('beginner'|'intermediate'|'advanced'), prerequisites (string array of tutorial IDs), estimatedMinutes (number), steps (TutorialStep array)
- `TutorialProgress`: tutorialId (string), lastStepIndex (number), completed (boolean), timestamp (number)

Create `src/lib/tutorial/progress.ts`:
- STORAGE_KEY = 'catune-tutorial-progress'
- `saveProgress(tutorialId: string, stepIndex: number, completed: boolean): void` -- reads existing, updates entry, writes back to localStorage
- `getProgress(tutorialId: string): TutorialProgress | null` -- reads from localStorage, returns entry or null
- `getAllProgress(): Record<string, TutorialProgress>` -- reads all, returns empty object on parse error
- `isCompleted(tutorialId: string): boolean` -- convenience wrapper
- `clearProgress(): void` -- removes storage key entirely

Use try/catch around JSON.parse for robustness. Import TutorialProgress type from types.ts.
  </action>
  <verify>
`npm ls driver.js` shows installed version. TypeScript compilation: `npx tsc --noEmit src/lib/tutorial/types.ts src/lib/tutorial/progress.ts` passes with no errors.
  </verify>
  <done>
driver.js 1.4.x installed. types.ts exports TutorialStep, Tutorial, TutorialProgress interfaces. progress.ts exports saveProgress, getProgress, getAllProgress, isCompleted, clearProgress functions with localStorage persistence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tutorial store, engine, and dark theme CSS</name>
  <files>
    src/lib/tutorial/tutorial-store.ts
    src/lib/tutorial/tutorial-engine.ts
    src/styles/tutorial.css
  </files>
  <action>
Create `src/lib/tutorial/tutorial-store.ts`:
- Module-level SolidJS signals following the same pattern as viz-store.ts and multi-cell-store.ts:
  - `[activeTutorial, setActiveTutorial]` = createSignal&lt;Tutorial | null&gt;(null)
  - `[currentStepIndex, setCurrentStepIndex]` = createSignal&lt;number&gt;(0)
  - `[isTutorialActive, setIsTutorialActive]` = createSignal&lt;boolean&gt;(false)
  - `[tutorialActionFired, setTutorialActionFired]` = createSignal&lt;boolean&gt;(false) -- used by interactive steps to detect user interaction
- Export all signals and setters as named exports

Create `src/lib/tutorial/tutorial-engine.ts`:
- Import `driver` from 'driver.js' and 'driver.js/dist/driver.css'
- Import '../styles/tutorial.css' (dark theme overrides -- must come AFTER driver.css)
  Wait -- css import from engine won't work cleanly. Instead, import tutorial.css from the engine file using a relative path: `import '../../styles/tutorial.css'`
- Import types from './types', store setters from './tutorial-store', progress functions from './progress'
- Module-level `driverInstance: ReturnType<typeof driver> | null = null`
- `mapSteps(tutorial: Tutorial): DriveStep[]` function:
  - Maps each TutorialStep to a driver.js DriveStep object
  - For steps with `waitForAction`, set `disableActiveInteraction: false` on the step AND override `onNextClick` in popover to only call `driverInstance.moveNext()` when `tutorialActionFired()` is true. Reset `setTutorialActionFired(false)` in `onHighlighted`.
  - For steps without waitForAction, no special handling
  - Use element selector string directly (driver.js re-queries on each step -- handles SolidJS re-renders per Research Pitfall 3)
  - Set popover.side from step.side
- `startTutorial(tutorial: Tutorial, resumeFromStep?: number): void`:
  - Destroys existing driverInstance if any
  - Calls mapSteps to build DriveStep array
  - Creates driver instance with config: showProgress=true, progressText='{{current}} of {{total}}', animate=true, allowClose=true, overlayOpacity=0.6, popoverClass='catune-tutorial'
  - Sets onHighlightStarted: update currentStepIndex signal, save progress to localStorage
  - Sets onDestroyed: setIsTutorialActive(false), save completed progress, set activeTutorial to null, null out driverInstance
  - Sets onDestroyStarted: call driverInstance.destroy() to allow close
  - Calls setActiveTutorial(tutorial), setIsTutorialActive(true)
  - Calls driverInstance.drive(resumeFromStep ?? 0)
- `stopTutorial(): void` -- calls driverInstance?.destroy()
- `notifyTutorialAction(): void` -- sets tutorialActionFired(true), calls driverInstance?.moveNext() if isTutorialActive()
  Wait -- the action should just set the flag. The onNextClick handler should check the flag and advance. Let me refine:
  - `notifyTutorialAction()` sets `setTutorialActionFired(true)`. For interactive steps, the onNextClick handler in mapSteps checks `tutorialActionFired()` and if true calls `driverInstance.moveNext()`. The user can also click next after performing the action.
  Actually, simpler approach: `notifyTutorialAction()` sets the flag AND if a tutorial is active, directly calls `driverInstance?.moveNext()`. This auto-advances when the user performs the required action. The onNextClick override for waitForAction steps simply blocks manual next-clicks until the action fires.

Create `src/styles/tutorial.css`:
- Override driver.js default light theme to match CaTune dark theme using CSS custom properties from global.css
- Target `.driver-popover` (driver.js applies this class): background var(--bg-secondary), color var(--text-primary), border 1px solid var(--bg-surface), border-radius var(--radius-md), box-shadow 0 8px 32px rgba(0,0,0,0.5)
- `.driver-popover .driver-popover-title`: color var(--accent), font-size 1.1rem, font-weight 600
- `.driver-popover .driver-popover-description`: color var(--text-primary), font-size 0.95rem, line-height 1.5
- `.driver-popover .driver-popover-progress-text`: color var(--text-secondary)
- `.driver-popover-prev-btn, .driver-popover-next-btn`: background var(--accent), color var(--bg-primary), border none, border-radius var(--radius-sm), padding var(--space-xs) var(--space-md), font-weight 600, cursor pointer
- `.driver-popover-prev-btn`: background transparent, color var(--text-secondary), border 1px solid var(--text-secondary)
- `.driver-popover-close-btn`: color var(--text-secondary)
- `.driver-overlay`: leave default (driver.js handles opacity via config)
  </action>
  <verify>
`npx tsc --noEmit` passes. Verify tutorial.css file exists and contains .driver-popover rules. Verify tutorial-engine.ts imports driver.js and exports startTutorial, stopTutorial, notifyTutorialAction.
  </verify>
  <done>
Tutorial store exports reactive signals (activeTutorial, currentStepIndex, isTutorialActive, tutorialActionFired). Tutorial engine exports startTutorial (with resume support), stopTutorial, notifyTutorialAction. Dark theme CSS overrides driver.js popover styling to match CaTune theme. Interactive step detection wired via tutorialActionFired signal.
  </done>
</task>

</tasks>

<verification>
1. `npm ls driver.js` shows 1.4.x
2. `npx tsc --noEmit` passes with no type errors
3. All 5 new files exist under src/lib/tutorial/ and src/styles/
4. tutorial-engine.ts imports from driver.js, tutorial-store, progress, and types
5. tutorial.css contains dark theme overrides matching CaTune's CSS custom properties
</verification>

<success_criteria>
- driver.js installed as a project dependency
- Tutorial type system provides compile-time safety for step definitions
- Progress module persists completion state to localStorage
- Tutorial engine can accept a Tutorial object and drive a themed driver.js tour
- Dark theme CSS makes driver.js popovers visually consistent with CaTune
</success_criteria>

<output>
After completion, create `.planning/phases/06-tutorial-system/06-01-SUMMARY.md`
</output>
